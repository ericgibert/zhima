API Catalogue
=============

Table of Content
----------------

1. Introduction
1. Member JSON Structure
1. Response JSON Structure
1. Get Member Information
1. Add a New Member without Payment
1. Add a New Member with Payment
1. Update an Exisiting Member
1. Add a Payment (Transaction) to an Existing Member
1. Extra API


1. Introduction
---------------

To call the API exposed, you need:

- Use the right 'verb': *POST*, *GET*, *PATCH*
- Pass the expected JSON structure in the message body
- Retrieve the response as a JSON structure

In this document, the IP address _127.0.0.1_ is used. This address has to be replaced *in situ* by the real IP .


2. Member JSON Structure
------------------------

Member is defined as:

    {
        openid: "ozckH0TkSadGgyeAb5Bn390qQMa8",   // the only and unique ID of a member.
        avatarUrl: "https://wx.qlogo.cn/mmopen/vi_32/GPm0HkJtcIsWkZmVNaxJP19ibl1g2YJTEibglP0UibOZstaRN1lbuMavu1a1Y795p6J1vHz0bM27icibCiat9ERricyng/0",    // member`s PICTURE
        basicInfo:
          {
            city: "",
            country: "South Korea",
            gender: 1,
            language: "zh_CN",
            nickName: "JOHN:",
            province: ""
          },
        memberInfo:
        {
            createTime: '201505011522'        // first time of member`s info creation in this system
            lastUpdate: '201801011420',       // last member information modification time
            lastActiveTime: '201803021530',   // last member active time (e.g: came to xinchejian and operate something)
            lastActiveType: 'Open the door/ paid for membership',    // lastest action type: opened the door or paid the membership or bought a drink from xcj
            expireTime: '201903111928',       // membership expire date and time
            tags: [ 'VISITOR', 'MEMBER', 'MASTER', 'GROUP', 'STAFF', 'ADMIN'],       // member`s tag, to decide the priviledge of a member
            memo: ''            // for admin use: take extra notes, e.g:this member asked for refund.
        },
        paymentInfo:
        {
            paidTime: '201803121929',     // last payment date and time
            payIndex: '9cu293820xxjfiuewfdsfdse32',   // the lastest payment index number, this is a unique random codes generated by wechat pay and alipay system and our system.
            CNYAmount: '3200',            // how much is the last payment.
            payType: [ '1M MEMBERSHIP', '6M MEMBERSHIP', 'DONATION', 'EVENT', 'TOOL', 'CROWD FUNDING'  ]
        }
    }



3. Response JSON Structure
--------------------------

Classic Response for a successful operation:

    {
        'errno': '1000',  #// no error with 1000, error numbers for others
        'errmsg': "Success",
        'data': {'new_id': new_id}   # // you may put data at here,in json format.
    }

Any error number _errno_ > 1000 indicates an error. Refer to the _errmsg_ for more information.

- 1001: Member information is missing and prevents the Member JSO structure generation
- 1002: Member JSON object received in the API body is NOT correct
- 1003: Member cannot be instered in database: database integrity/duplicate key on insert (like nickname duplicate)
- 1004: Failure to update a member record
- 1005: Failure to insert a transaction record

- 1998: Incorrect number of seconds (must be an integer)
- 1999: Member not found (_GET_ or _PATCH_)


    
4. Get Member Information
--------------------------

### Path:
GET _http://127.0.0.1:8080/api/v1.0/member/openid/<openid\>_

Replace _<openid\>_ by the Member's openid.

### Body:
Empty

### Response:
Member JSON object

5. Add New Member without Payment
---------------------------------

### Path:
POST _http://127.0.0.1:8080/api/v1.0/member/new_

### Body:
The Member JSON structure expected.
The 'paymentInfo' part is not provided.

- The member is created but its status is set to 'NOT_OK'
- Its password is set to _password123_


### Response:
In case of success:

    {
        'errno': '1000', 
        'errmsg': 'Success', 
        'data': 
        {
            'new_id': 123574, 
            'qrcode_url': '/images/XCJ_123574.png?1523680364.6269844'
        }
    }

6. Add New Member with Payment
------------------------------

### Path:
POST _http://127.0.0.1:8080/api/v1.0/member/new_

### Body:
The Member JSON structure expected.
The 'paymentInfo' part is provided.

- The member is created
- Its status is set to 'OK' if the payment concerns a valid membership
- Its password is set to _password123_


### Response:
In case of success:

    {
        'errno': '1000',
        'errmsg': 'Success',
        'data':
        {
            'new_id': 123574,
            'qrcode_url': '/images/XCJ_123574.png?1523680364.6269844'
        }
    }


7. Update an Exisiting Member
-----------------------------

### Path:
PATCH _http://127.0.0.1:8080/api/v1.0/member/openid/<openid\>_

### Body:

- The 'op' operation must be 'update'
- The 'data' list the key/value pair of the authorized field to update
- The authorized field to update are declared in *Member_Api.py* as *API_MAPPING_TO_DB*

        {
            'op': 'update',
            'data': {
                'avatarUrl': 'https://new/link/to_avatar.html',
                'nickName': 'new_nickName',
                'tags': 5
            }
        }



### Response:
In case of success:

    {
        'errno': '1000',
        'errmsg': 'Success',
        'data':
        {
            'new_id': 123574,
            'qrcode_url': '/images/XCJ_123574.png?1523680364.6269844'
        }
    }



8. Add a Payment (Transaction) to an Existing Member
----------------------------------------------------


### Path:
PATCH _http://127.0.0.1:8080/api/v1.0/member/openid/<openid\>_

### Body:

- The 'op' operation must be 'add'
- The 'data' list the key/value pair of the authorized field to insert a new payment

        patch = {
            "op": "add",
            "data": {
                'paidTime': '201803121929',
                'payIndex': 'this is craaaazy!',
                'CNYAmount': 123.45,
                'payType': 'DONATION'
            }
        }

### Response:
In case of success:

    {
        'errno': '1000',
        'errmsg': 'Success',
        'data':
        {
            'new_id': 123574,
            'qrcode_url': '/images/XCJ_123574.png?1523680364.6269844'
        }
    }


9. Extra API
------------


### Path:
POST _http://127.0.0.1:8080/api/v1.0/open/seconds_

### Body:
Opens the door the for given number of seconds:


    { 'seconds': 3 }

### Response:
In case of success:

    {
         'errno': '1000'
         'errmsg': 'Door is now closed'
         'data':
         {
         }
    }


In case of error:

    {
         'errno': '1998'
         'errmsg': 'Incorrect call to open the door:not good!'
         'data':
         {
         }
    }

